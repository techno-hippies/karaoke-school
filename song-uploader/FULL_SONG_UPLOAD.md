# Full Song Upload System

Complete guide for uploading full songs with karaoke metadata, images, and optional music videos.

## Overview

The full song upload system complements the clip-based system by providing:

1. **Complete song playback** - Full audio files for listening/performance mode
2. **Full karaoke metadata** - Word+line timestamps for entire song
3. **Optimized images** - High-res cover + 300x300 thumbnail
4. **Music video support** - Optional Grove URI for music videos
5. **Multilingual support** - Translations embedded in metadata

## Required Files

### Minimum Required

```
songs/Artist - Title/
  ‚îú‚îÄ‚îÄ Artist - Title.mp3           # Full audio file
  ‚îú‚îÄ‚îÄ lyrics.txt                    # Lyrics with section markers
  ‚îú‚îÄ‚îÄ song-cover.png                # High-res cover image
  ‚îî‚îÄ‚îÄ karaoke-alignment.json        # ElevenLabs output (auto-generated)
```

### Full Setup

```
songs/Artist - Title/
  ‚îú‚îÄ‚îÄ Artist - Title.mp3                    # Full audio
  ‚îú‚îÄ‚îÄ Artist - Title (Vocals).mp3           # Optional: isolated vocals
  ‚îú‚îÄ‚îÄ Artist - Title (Instrumental).mp3     # Optional: backing track
  ‚îú‚îÄ‚îÄ lyrics.txt                             # Lyrics with [Section] markers
  ‚îú‚îÄ‚îÄ song-cover.png                         # High-res (1000x1000+)
  ‚îú‚îÄ‚îÄ song-cover-thumb.png                  # Auto-generated 300x300
  ‚îú‚îÄ‚îÄ music-video-uri.txt                   # Optional: lens://...
  ‚îú‚îÄ‚îÄ karaoke-alignment.json                # Auto-generated by ElevenLabs
  ‚îú‚îÄ‚îÄ full-song-metadata.json               # Auto-generated by generator
  ‚îú‚îÄ‚îÄ translations/
  ‚îÇ   ‚îú‚îÄ‚îÄ cn.txt
  ‚îÇ   ‚îú‚îÄ‚îÄ vi.txt
  ‚îÇ   ‚îî‚îÄ‚îÄ es.txt
  ‚îî‚îÄ‚îÄ clips/                                 # Generated by slice command
```

## Complete Pipeline

### Step 1: Add song-cover.png

Place your high-resolution cover image as `song-cover.png` in the song folder.

**Requirements:**
- Format: PNG
- Recommended size: 1000x1000px or larger
- Square aspect ratio (will be cropped if not)

### Step 2: Generate Thumbnail

```bash
bun run generate-thumbnails --song "Artist - Title"
```

**What it does:**
- Reads `song-cover.png`
- Generates `song-cover-thumb.png` (300x300, center-cropped)
- Optimizes for fast loading in feeds
- Skips if thumbnail already exists

**Force regeneration:**
```bash
bun run generate-thumbnails --force --song "Artist - Title"
```

### Step 3: Run ElevenLabs Alignment

```bash
bun run elevenlabs --song "Artist - Title"
```

**What it does:**
- Sends audio + lyrics to ElevenLabs API
- Gets word-level timestamps for entire song
- Saves to `karaoke-alignment.json`
- Uses cached result if file exists

### Step 4: Generate Full-Song Metadata

```bash
bun run generate-full-metadata --song "Artist - Title"
```

**What it does:**
- Combines ElevenLabs word timestamps
- Maps words to lyrics lines
- Adds section markers ([Verse], [Chorus], etc.)
- Embeds all translations
- Generates `full-song-metadata.json`

**Output format:**
```json
{
  "version": 3,
  "id": "artist-title",
  "title": "Title",
  "artist": "Artist",
  "duration": 180.5,
  "format": "word-and-line-timestamps",
  "lines": [
    {
      "lineIndex": 0,
      "originalText": "[Verse]",
      "start": 0,
      "end": 0,
      "words": [],
      "sectionMarker": true
    },
    {
      "lineIndex": 1,
      "originalText": "First line of lyrics",
      "translations": {
        "cn": "Á¨¨‰∏ÄË°åÊ≠åËØç",
        "vi": "D√≤ng ƒë·∫ßu ti√™n"
      },
      "start": 2.5,
      "end": 5.8,
      "words": [
        { "text": "First", "start": 2.5, "end": 2.9 },
        { "text": "line", "start": 3.0, "end": 3.4 },
        { "text": "of", "start": 3.5, "end": 3.7 },
        { "text": "lyrics", "start": 3.8, "end": 4.3 }
      ]
    }
  ],
  "availableLanguages": ["en", "cn", "vi"],
  "generatedAt": "2025-10-02T...",
  "elevenLabsProcessed": true,
  "wordCount": 450,
  "lineCount": 48,
  "sectionIndex": [
    { "type": "Verse", "lineIndex": 0, "timestamp": 2.5 },
    { "type": "Chorus", "lineIndex": 8, "timestamp": 45.2 }
  ]
}
```

### Step 5: (Optional) Add Music Video URI

If you have a music video uploaded to Grove, create a text file:

```bash
echo "lens://abc123..." > "songs/Artist - Title/music-video-uri.txt"
```

### Step 6: Upload to Grove

```bash
# Test first (dry run)
bun run upload-full-songs --dry-run --song "Artist - Title"

# Real upload
bun run upload-full-songs --song "Artist - Title"
```

**What gets uploaded:**
1. `audio.mp3` - Full song audio
2. `metadata.json` - Full karaoke data (word+line timestamps)
3. `song-cover.png` - High-res cover image
4. `song-cover-thumb.png` - 300x300 thumbnail
5. Music video URI (if `music-video-uri.txt` exists)

**Grove URIs returned:**
```json
{
  "songId": "artist-title",
  "folderUri": "lens://folder-hash",
  "audioUri": "lens://audio-hash",
  "metadataUri": "lens://metadata-hash",
  "coverUri": "lens://cover-hash",
  "thumbnailUri": "lens://thumb-hash",
  "musicVideoUri": "lens://video-hash"  // Optional
}
```

## Batch Processing

Process all songs at once:

```bash
# Generate all thumbnails
bun run generate-thumbnails --all

# Generate all full-song metadata
bun run generate-full-metadata --all

# Upload all full songs
bun run upload-full-songs --all
```

## Image Optimization Details

### Why Two Images?

**song-cover.png (high-res)**
- Used in detail views, player UI
- Typically 1000x1000px or larger
- ~300-500 KB file size
- Provides high quality for large displays

**song-cover-thumb.png (thumbnail)**
- Used in feed views, lists, cards
- Exactly 300x300px
- ~30-50 KB file size
- 10x smaller = 10x faster loading
- Critical for mobile performance

### Generation Process

The thumbnail generator:
1. Reads `song-cover.png`
2. Resizes to 300x300 using center crop
3. Optimizes PNG with quality: 85, compression: 9
4. Saves as `song-cover-thumb.png`

### Force Regeneration

If you update `song-cover.png`, regenerate the thumbnail:

```bash
bun run generate-thumbnails --force --song "Artist - Title"
```

## Music Video Support

### Adding a Music Video

1. **Upload video to Grove separately** (video upload tool TBD)
2. **Get the Grove URI** (e.g., `lens://video-abc123`)
3. **Add to song folder:**
   ```bash
   echo "lens://video-abc123" > "songs/Artist - Title/music-video-uri.txt"
   ```
4. **Upload song** - The video URI will be included in the upload result

### Use Cases

- **Music video playback** - Full video with subtitles
- **Lyric video** - Animated lyrics over background
- **Performance video** - Live performance recording
- **Visualizer** - Abstract visuals synced to audio

The URI is stored alongside audio/metadata URIs for use in the app.

## Full Song Metadata Format

### Section Markers

Section markers are preserved from `lyrics.txt`:

```typescript
{
  "lineIndex": 5,
  "originalText": "[Chorus]",
  "start": 0,
  "end": 0,
  "words": [],
  "sectionMarker": true  // Flag for UI
}
```

### Section Index

Quick navigation to sections:

```typescript
"sectionIndex": [
  { "type": "Intro", "lineIndex": 0, "timestamp": 0.0 },
  { "type": "Verse", "lineIndex": 1, "timestamp": 2.5 },
  { "type": "Chorus", "lineIndex": 8, "timestamp": 45.2 },
  { "type": "Verse", "lineIndex": 16, "timestamp": 80.1 },
  { "type": "Chorus", "lineIndex": 24, "timestamp": 115.5 },
  { "type": "Bridge", "lineIndex": 32, "timestamp": 145.8 },
  { "type": "Chorus", "lineIndex": 40, "timestamp": 165.2 },
  { "type": "Outro", "lineIndex": 48, "timestamp": 195.0 }
]
```

## Storage & Registry

### Current State

Full songs are uploaded to Grove but **not yet registered in a contract**.

### Next Steps

1. **Create SongRegistry contract** (or extend ClipRegistry)
2. **Add fields:**
   ```solidity
   struct Song {
     string id;
     string title;
     string artist;
     uint32 duration;
     string audioUri;           // Full song audio
     string metadataUri;        // Full karaoke metadata
     string coverUri;           // High-res cover
     string thumbnailUri;       // 300x300 thumbnail
     string musicVideoUri;      // Optional
     string[] clipIds;          // Related clips
     string[] languages;        // Available translations
     bool enabled;
   }
   ```
3. **Deploy contract**
4. **Update upload script** to register songs

## Example Workflow

### Complete Song Setup

```bash
cd song-uploader

# 1. Add files to folder
mkdir -p "songs/Ethel Waters - Down Home Blues"
# Copy: audio.mp3, lyrics.txt, song-cover.png, translations/*.txt

# 2. Validate format
bun run validate --song "Ethel Waters - Down Home Blues"

# 3. Generate thumbnail
bun run generate-thumbnails --song "Ethel Waters - Down Home Blues"

# 4. Get ElevenLabs alignment
bun run elevenlabs --song "Ethel Waters - Down Home Blues"

# 5. Generate full-song metadata
bun run generate-full-metadata --song "Ethel Waters - Down Home Blues"

# 6. (Optional) Generate clips
bun run slice --song "Ethel Waters - Down Home Blues"

# 7. Test upload (dry run)
bun run upload-full-songs --dry-run --song "Ethel Waters - Down Home Blues"

# 8. Upload to Grove
bun run upload-full-songs --song "Ethel Waters - Down Home Blues"

# 9. (Optional) Upload clips
bun run upload-clips --song "Ethel Waters - Down Home Blues"
```

### Output

```
üìÄ Ethel Waters - Down Home Blues
  üîÑ Processing full song...
  üì§ Uploading to Grove...
  ‚úÖ Uploaded to Grove

  üìã Upload Result:
     Folder: lens://folder-hash
     Audio: lens://audio-hash
     Metadata: lens://metadata-hash
     Cover: lens://cover-hash
     Thumbnail: lens://thumb-hash

‚úÖ All songs uploaded successfully!

‚ö†Ô∏è  TODO: Store these URIs in your song registry/contract
```

## Dependencies

```bash
cd song-uploader
bun install
```

**New dependency:**
- `sharp`: Image processing (thumbnail generation)

## Troubleshooting

### "No song-cover.png found"

Add a high-res cover image to your song folder:
```bash
cp cover.png "songs/Artist - Title/song-cover.png"
```

### "No full-song-metadata.json"

Run the metadata generator first:
```bash
bun run generate-full-metadata --song "Artist - Title"
```

### "No karaoke-alignment.json"

Run ElevenLabs alignment first:
```bash
bun run elevenlabs --song "Artist - Title"
```

### Thumbnail looks wrong

Regenerate with --force:
```bash
bun run generate-thumbnails --force --song "Artist - Title"
```

### Sharp installation issues

Bun should handle sharp automatically, but if issues arise:
```bash
bun add sharp
```

## Performance

### Upload Sizes

Typical full song upload:
- Audio: 3-5 MB (MP3, 3-5 minutes)
- Metadata: 50-200 KB (depends on word count)
- Cover: 300-500 KB (1000x1000 PNG)
- Thumbnail: 30-50 KB (300x300 PNG)
- **Total: ~4-6 MB per song**

### Generation Times

- Thumbnail: <1 second
- Full metadata: <1 second (already has alignment)
- Total: ~1-2 seconds per song

### Upload Times

Depends on Grove network:
- Local testing: ~5-10 seconds
- Production: ~30-60 seconds

## Future Enhancements

1. **Platform metadata** - Spotify IDs, Apple Music links, etc.
2. **Song registry contract** - On-chain indexing
3. **Music video upload tool** - Integrated video handling
4. **Automatic thumbnail styles** - Genre-specific templates
5. **Cover art generation** - AI-generated covers for missing images
