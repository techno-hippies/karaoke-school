"""
A processed clip of a song (40-80s karaoke clip with translations)
References GRC-20 work entity for music metadata
"""
type Clip @entity(immutable: false) {
  id: ID! # clipHash
  clipHash: Bytes!

  # GRC-20 reference
  grc20WorkId: String!

  # Clip timing and metadata
  spotifyTrackId: String!
  clipStartMs: Int!
  clipEndMs: Int!
  metadataUri: String!
  registeredBy: Bytes!
  registeredAt: BigInt!

  # Artist linking (from Grove metadata)
  artistLensHandle: String

  # Populated after processing
  instrumentalUri: String
  alignmentUri: String
  processedAt: BigInt
  translationCount: Int!
  encryptedFullUri: String
  encryptedManifestUri: String
  unlockLockAddress: Bytes
  unlockChainId: Int

  # Relations
  performances: [Performance!]! @derivedFrom(field: "clip")
  translations: [Translation!]! @derivedFrom(field: "clip")
  exerciseCards: [ExerciseCard!]! @derivedFrom(field: "clip")

  # Computed flags
  performanceCount: Int!
  averageScore: BigDecimal!
  hasInstrumental: Boolean!
  hasAlignments: Boolean!
  hasEncryptedFull: Boolean!
}

"""
A multi-language translation for a clip
"""
type Translation @entity(immutable: false) {
  id: ID! # clipHash + languageCode
  clip: Clip!
  clipHash: Bytes!
  languageCode: String!
  translationUri: String!
  translationSource: String!
  confidenceScore: Int!
  validated: Boolean!
  addedBy: Bytes!
  addedAt: BigInt!
  updatedAt: BigInt
  enabled: Boolean!

  # Computed
  confidenceLevel: String!
}

"""
A graded performance of a clip (legacy aggregate)
"""
type Performance @entity(immutable: true) {
  id: ID!
  performanceId: BigInt!
  clip: Clip!
  performer: Account!
  performerAddress: Bytes!
  score: Int!
  metadataUri: String!
  gradedAt: BigInt!

  # Denormalized for queries
  clipHash: Bytes!
}

"""
A karaoke line tracked for spaced repetition
"""
type LineCard @entity(immutable: false) {
  id: ID!
  lineId: Bytes!
  clip: Clip!
  clipHash: Bytes!
  lineIndex: Int!

  performances: [LinePerformance!]! @derivedFrom(field: "line")
  exerciseCards: [ExerciseCard!]! @derivedFrom(field: "line")

  performanceCount: Int!
  averageScore: BigDecimal!
}

"""
A graded performance of a single line
"""
type LinePerformance @entity(immutable: true) {
  id: ID!
  performanceId: BigInt!
  line: LineCard!
  lineId: Bytes!
  clip: Clip!
  clipHash: Bytes!
  lineIndex: Int!
  performer: Account!
  performerAddress: Bytes!
  score: Int!
  metadataUri: String!
  gradedAt: BigInt!
}

"""
Lens account with performance and exercise history
"""
type Account @entity(immutable: false) {
  id: ID!
  lensAccountAddress: Bytes!
  pkpAddress: Bytes!
  username: String!
  metadataUri: String!
  createdAt: BigInt!
  updatedAt: BigInt!
  verified: Boolean!

  performances: [Performance!]! @derivedFrom(field: "performer")
  exerciseAttempts: [ExerciseAttempt!]! @derivedFrom(field: "performer")

  performanceCount: Int!
  totalScore: BigInt!
  averageScore: BigDecimal!
  bestScore: Int!
}

"""
Global statistics
"""
type GlobalStats @entity(immutable: false) {
  id: ID!
  totalClips: Int!
  totalPerformances: Int!
  totalAccounts: Int!
  totalTranslations: Int!
  enabledTranslations: Int!
  totalExerciseCards: Int!
  totalExerciseAttempts: Int!
  totalKaraokeSessions: Int!
  completedKaraokeSessions: Int!
}

"""
Leaderboard entry for clip performances
"""

enum ExerciseType {
  SAY_IT_BACK
  TRANSLATION_MULTIPLE_CHOICE
  TRIVIA_MULTIPLE_CHOICE
}

"""
An FSRS-tracked exercise card (audio or multiple choice)
"""
type ExerciseCard @entity(immutable: false) {
  id: ID! # questionId / lineId hex
  questionId: Bytes!
  exerciseType: ExerciseType!
  spotifyTrackId: String!
  languageCode: String!
  metadataUri: String!
  distractorPoolSize: Int!
  enabled: Boolean!
  createdAt: BigInt!
  registeredBy: Bytes!

  # Optional relations (translation-specific)
  clip: Clip
  clipHash: Bytes
  line: LineCard
  lineId: Bytes
  lineIndex: Int

  # Derived attempts
  attempts: [ExerciseAttempt!]! @derivedFrom(field: "card")
  attemptCount: Int!
  averageScore: BigDecimal!
}

"""
Learner attempt for an exercise card (immutable history)
"""
type ExerciseAttempt @entity(immutable: true) {
  id: ID! # attemptId
  attemptId: BigInt!
  card: ExerciseCard!
  questionId: Bytes!
  performer: Account!
  performerAddress: Bytes!
  score: Int!
  rating: Int!
  metadataUri: String!
  gradedAt: BigInt!
}

"""
A karaoke session for line-by-line grading (real-time feedback)
Aggregates line scores from KaraokeLineGraded events
"""
type KaraokeSession @entity(immutable: false) {
  id: ID! # sessionId hex
  sessionId: Bytes!
  clip: Clip!
  clipHash: Bytes!
  performer: Bytes!
  expectedLineCount: Int!

  # Derived from events
  lines: [KaraokeLineScore!]! @derivedFrom(field: "session")
  completedLineCount: Int!
  aggregateScore: Int! # Average of line scores (0-10000)
  isCompleted: Boolean!
  wasAbandoned: Boolean!

  startedAt: BigInt!
  endedAt: BigInt
}

"""
A graded line within a karaoke session
"""
type KaraokeLineScore @entity(immutable: true) {
  id: ID! # sessionId-lineIndex
  session: KaraokeSession!
  sessionId: Bytes!
  lineIndex: Int!
  score: Int! # 0-10000 basis points
  rating: Int! # FSRS 0-3
  metadataUri: String!
  timestamp: BigInt!
}
