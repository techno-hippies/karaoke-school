"""
A processed segment of a song (karaoke audio with translations)
References GRC-20 work entity for music metadata (decoupled design)
"""
type Segment @entity(immutable: false) {
  id: ID! # segmentHash
  segmentHash: Bytes!

  # GRC-20 Reference (Public Music Metadata Layer)
  grc20WorkId: String! # GRC-20 musical work entity UUID (primary reference)

  # App-specific data
  spotifyTrackId: String! # Spotify track ID for audio matching
  segmentStartMs: Int! # Start time in milliseconds
  segmentEndMs: Int! # End time in milliseconds
  metadataUri: String!
  registeredBy: Bytes!
  registeredAt: BigInt!

  # Artist linking (from Grove metadata)
  artistLensHandle: String # Lens handle for artist profile linking

  # Set after processing
  instrumentalUri: String # Grove URI for instrumental (primary audio)
  alignmentUri: String # Grove URI for alignment metadata (ElevenLabs word timing)
  processedAt: BigInt
  translationCount: Int! # Number of translations available

  # Relations
  performances: [Performance!]! @derivedFrom(field: "segment")
  translations: [Translation!]! @derivedFrom(field: "segment")

  # Computed
  performanceCount: Int!
  averageScore: BigDecimal!
  hasInstrumental: Boolean!
  hasAlignments: Boolean!
}

"""
A multi-language translation for a segment
"""
type Translation @entity(immutable: false) {
  id: ID! # segmentHash + languageCode
  segment: Segment!
  segmentHash: Bytes!
  languageCode: String! # ISO 639-1 code (es, zh, ja, ko, etc.)
  translationUri: String! # Grove URI for translation JSON (line-level + word timing)
  translationSource: String! # AI model used (e.g., "gemini-flash-2.5")
  confidenceScore: Int! # 0-10000 (model confidence Ã— 10000)
  validated: Boolean! # Human-verified translation
  addedBy: Bytes!
  addedAt: BigInt!
  updatedAt: BigInt
  enabled: Boolean! # Whether translation is available

  # Computed
  confidenceLevel: String! # HIGH, MEDIUM, LOW based on confidenceScore
}

"""
A graded performance of a segment (DEPRECATED - use LinePerformance)
"""
type Performance @entity(immutable: true) {
  id: ID! # performanceId
  performanceId: BigInt!
  segment: Segment!
  performer: Account!
  performerAddress: Bytes!
  score: Int! # 0-10000 (basis points)
  metadataUri: String! # Grove URI for full performance metadata
  gradedAt: BigInt!

  # Denormalized for queries
  segmentHash: Bytes!
}

"""
A karaoke line (minimal tracking for FSRS)
Created dynamically when first performance is graded
Line content (text, timing) comes from Grove segment metadata
"""
type LineCard @entity(immutable: false) {
  id: ID! # lineId (UUID as hex)
  lineId: Bytes! # Stable UUID from karaoke_lines table
  segment: Segment!
  segmentHash: Bytes!
  lineIndex: Int! # Position within segment (for ordering)

  # Relations
  performances: [LinePerformance!]! @derivedFrom(field: "line")

  # Aggregate stats (computed from performances)
  performanceCount: Int!
  averageScore: BigDecimal!
}

"""
A graded performance of a single LINE (for FSRS tracking)
"""
type LinePerformance @entity(immutable: true) {
  id: ID! # performanceId
  performanceId: BigInt!
  line: LineCard!
  lineId: Bytes!
  segment: Segment!
  segmentHash: Bytes!
  lineIndex: Int!
  performer: Account!
  performerAddress: Bytes!
  score: Int! # 0-10000 (basis points)
  metadataUri: String!
  gradedAt: BigInt!
}

"""
Lens account with performance history
"""
type Account @entity(immutable: false) {
  id: ID! # lensAccountAddress
  lensAccountAddress: Bytes!
  pkpAddress: Bytes!
  username: String!
  metadataUri: String!
  createdAt: BigInt!
  updatedAt: BigInt!
  verified: Boolean! # Account verification status

  # Relations
  performances: [Performance!]! @derivedFrom(field: "performer")

  # Stats
  performanceCount: Int!
  totalScore: BigInt!
  averageScore: BigDecimal!
  bestScore: Int!
}

"""
Global statistics
"""
type GlobalStats @entity(immutable: false) {
  id: ID! # "global"
  totalSegments: Int!
  totalPerformances: Int!
  totalAccounts: Int!
  totalTranslations: Int!
  enabledTranslations: Int!
}

"""
Leaderboard entry for segment performances
"""
type SegmentLeaderboard @entity(immutable: false) {
  id: ID! # segmentHash
  segment: Segment!
  totalPerformers: Int!
  averageScore: BigDecimal!
  highestScore: Int!
  lowestScore: Int!
  createdAt: BigInt!
  updatedAt: BigInt!
}
